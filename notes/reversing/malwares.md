# Malware Behavior

## Downloaders
Downloaders download another piece of malware from the internet and execute it on the local system.

## Launchers
An executable that installs malware for immediate or future covert execution. 

## Backdoors
A type of malware that provides an attacker with remote access to a victim's machine. They provide various features such as the ability to manipulate registry keys, enumerate display windows, create directories, search files, etc.

## Reverse shell
A connection that originates from the infected machine and provides the attacker a remote shell on that machine.

## RAT
A remote administration tool is used to remotely manage a computer or computers. 


# Covert Launching
Let's have a look on various techniques used for launching (immediate or future execution) of malwares. The goal of a launcher is to setup things so that the malicious behavior is concealed from the users. Launchers store another malware in the resource section and extract the executable whenever the main program is run. Functions such as `FindResource`,`LoadResource`,`SizeofResource` are widely used.

## Process Injection
Process injection injects code into another running process which is then executed by that process. Functions such as, `OpenProcess` `VirtualAllocEx`(can be used to allocate space in a remote process if handle to the process is known),`WriteProcessMemory` and `CreateRemoteThread` are used for performing process injection.

Let's have a look on some famous process injection techniques

### 1. DLL Injection
DLL Injection is a form of process injection where a remote process is forced to load a malicious DLL by calling `LoadLibrary`. The `DLLMain` function is executed as soon as the DLL is loaded into a process. To inject DLL into a host program, the launcher must first obtain a handle to the victim process which can be done by using functions such as `CreateToolhelp32Snapshot`,`Process32First`,`Process32Next`,etc. The function `CreateRemoteThread` creates and executes a new thread in a remote process. One of its arguments is the starting point of the injected thread which can be set to `LoadLibrary` with argument as the dll to perform a DLL injection on the remote process. Malware authors generally use `VirtualAllocEx` to allocate some memory for the dll name in the remote process and then call `WriteProcessMemory` to write the string.

### 2. Direct Injection
It injects malicious code directly into a remote process. This is usually used to inject shellcode. Since the data and functions used by the remote thread must exist in the victim process, normal procedures might not work. Any person writing the code for direct injection must be highly skilled in writing assembly.

## Process Replacement
Rather than injecting code into a host program, some malwares use a technique known as process replacement to overwrite the memory space of a running process with a malicious executable. This technique provides malware the same privileges as the process it is replacing. The key to process replacement is creating a process in a suspended state. This means that the process will be loaded into memory, but the primary thread of the process is suspended. This can be done by creating a new process by using the function `CreateProcessA` and then calling `ZwUnmapViewOfSection` to release all the memory pointed to by a section passed as a parameter. After the memory is unmapped, the loader performs `VirtualAllocEx` to allocate new memory for the malware and use `WriteProcessMemory` to write each of the malware's sections to the victim process space. After that, the malware restores the victim process environment so that the malicious code can run by calling `SetThreadContext` to set the entry point to point to the malicious code and finally `ResumeThread` is called to initiate the malware.

## Hook Injection
A hook is an event by which an application can intercept events, such as messages, mouse actions, and keystrokes. There are two types of hooks: local and remote. Local hooks are used to observe or manipulate messages destined for an internal process whereas remote hooks are used to observe or manipulate messages destined for a remote process. Remote hooks are of two types: high level and low level. High level remote hooks require that the hook procedure be an exported function contained in a DLL that will be mapped by the OS into the process space of a hooked thread or all threads. Low level remote hooks require that the hook procedure be contained in the process that installed the hook. Hook injection is widely used in keyloggers.The main function used for remote hooking is `SetWindowsHookEx`.The function that intercepts the event is known as a hook procedure. Hook injection is widely used by malware authors to run malicious code whenever a particular message is intercepted, or for loading a particular DLL.

## APC Injection
Creation of a thread on a remote process using `CreateRemoteThread` requires some overhead. It is more efficient to invoke a function on an existing thread. An Asynchronous Procedure Call (APC) is a function that executes asynchronously in the context of a particular thread. When an APC is queued to a thread, the system issues a software interrupt. Every thread has a queue of APCs attached to it, and these are processed when the thread is in alertable state, such that when they call functions such as `WaitForSingleObjectEx`, `WaitForMultipleObjectsEx` and `SleepEx`. If an application queues an APC while the thread is alertable but before the thread begins running, the thread begins by calling the APC function. A thread calls the APC functions one by one for all APCs in its APC queue. When the APC queue is complete, the thread continues its normal execution path.
    To make an APC injection work, first of all, find the target process id. After that, allocate space in the target process for shellcode and write the shellcode into it. Call the function `CreateToolhelp32Snapshot` with `TH32CS_SNAPTHREAD` flag and iterate through all the threads using `Thread32First` and `Thread32Next` to find the threads belonging to the victim process. If the thread belongs to the target process, queue an APC using `QueueUserAPC` function, the first argument should be a pointer to the shellcode and the second parameter should be a handle to a remote thread.

