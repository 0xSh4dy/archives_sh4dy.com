---
layout: post
title: Conti Ransomware
tags: [ransomware, malware]
---

## Overview

`Packed Sample` : [https://bazaar.abuse.ch/sample/03b9c7a3b73f15dfc2dcb0b74f3e971fdda7d1d1e2010c6d1861043f90a2fecd/](https://bazaar.abuse.ch/sample/03b9c7a3b73f15dfc2dcb0b74f3e971fdda7d1d1e2010c6d1861043f90a2fecd/)

`Unpacked Sample` : [https://bazaar.abuse.ch/sample/d3c75c5bc4ae087d547bd722bd84478ee6baf8c3355b930f26cc19777cd39d4c/](https://bazaar.abuse.ch/sample/d3c75c5bc4ae087d547bd722bd84478ee6baf8c3355b930f26cc19777cd39d4c/)

`MD5` : B3D6BA0AA663F699283D25DDCB6561B9

`SHA 256`: D3C75C5BC4AE087D547BD722BD84478EE6BAF8C3355B930F26CC19777CD39D4C

This post deals with the unpacked sample. 

## Basic Static Analysis

* According to PE Bear as well as IDA, the ransomware imports three DLLs namely `kernel32.dll`, `USER32.dll` and `WS2_32.dll`.

* Interesting data found by extracting strings from the executable
```
Our website
TOR VERSION : 
(you should download and install TOR browser first https://torproject.org) 
http://m232fdxbfmbrcehbrj5iayknxnggf6niqfj6x4iedrgtab4qupzjlaid.onion 
HTTPS VERSION : 
contirecovery.best
YOU SHOULD BE AWARE! 
Just in case, if you try to ignore us. We've downloaded you
---BEGIN ID---
sRttGzzkzsoiC9s8LgcrQk64ew7H47a5JSjCsLGbwdijogjulfu3RO9XBJbfEgCZ
---END ID---
.CECJF
RSA1
```

- This reveals the name of the malware `A:\source\conti_v3\Release\cryptor.pdb`

## Advanced Static Analysis

### String Decryption
Analysing the function `sub_401010` in IDA, we notice some stack strings and their corresponding decryption loop. We can extract those strings and write a decryptor.

```py
enc_s_1 = [1,16,47,57,16,62,14,80 ,90 ,82 ,62, 62, 78]
enc_s_2 = [104, 84, 13 ,111,18,13,120,9,49,49,17]
enc_s_3 = [15,6,5,112,90,41,44,37,9,6,0x3e,0x3e]
enc_s_4 = [11,22,35,92,92,63,35,92,92,21]
enc_s_5 = [39,85,71,99,71,42,126,99,35,41,56,56,44]
enc_s_6 = [96,115,71,47,77,70,101,115,115,53]
enc_s_7 = [101,97,6,46,87,74,118,105,53,120,97,97,90]
enc_s_8 = [50,78,30,40,119,116,111,38,0,5,81,81,71]
enc_s_9 = [90,123,126,61,123,81,123,78,116,64,61,61,38]
enc_s_10 = [73,77,108,98,118,12,53,72,46,108,108,33]
enc_s_11 = [81,92,36,82,82,34,100,110,102,82,82,98]

def decrypt_string_1(buffer,flag,k1,k2):
	if flag == -1:
		for i in range(len(buffer)):
			print(chr((k1 * (buffer[i] - k2) % 127 + 127) % 127),end='')
	else:
		for i in range(len(buffer)):
			print(chr((k1 * (k2-buffer[i]) % 127 + 127) % 127),end='')
	print()

decrypt_string_1(enc_s_1,-1,25,78)
decrypt_string_1(enc_s_2,-1,51,17)
decrypt_string_1(enc_s_3,1,18,68)
decrypt_string_1(enc_s_4,1,11,21)
decrypt_string_1(enc_s_5,-1,9,44)
decrypt_string_1(enc_s_6,-1,55,53)
decrypt_string_1(enc_s_7,1,39,90)
decrypt_string_1(enc_s_8,1,40,71)
decrypt_string_1(enc_s_9,1,45,38)
decrypt_string_1(enc_s_10,-1,37,33)
decrypt_string_1(enc_s_11,-1,25,98)
```

Running this script gives us the names of some DLLs. However, PE Bear was able to detect only three DLLs. This means that the program might be loading these DLLs manually using some API function.
```
Î» python decryptor.py
kernel32.dll
ws2_32.dll
Advapi32.dll
ntdll.dll
Rstrtmgr.dll
Ole32.dll
OleAut32.dll
Netapi32.dll
Iphlpapi.dll
Shlwapi.dll
Shell32.dll
```
